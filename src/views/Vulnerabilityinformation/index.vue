<template>
  <div>   
    <div class="topButton" style="white-space: nowrap;min-width:800px">
        <el-row :gutter="50">
        <el-col :span="4" >
            <el-tooltip content="模板下载" placement="top" >
                  <el-button icon ="el-icon-download" type="warning" size ="small" @click="downloadFile" round>模板下载</el-button> 
            </el-tooltip>
      </el-col>
      <el-col :span="4" >
            <el-tooltip content="批量导入" placement="top" >
                  <el-button icon ="el-icon-upload2" type="primary" size ="small" @click="importButton" round>批量导入</el-button> 
            </el-tooltip>
      </el-col>
      <el-col :span="6" >
        <el-button  icon ="el-icon-document-add" @click="handleAdd" plain  v-waves  type="primary" size ="small" round >新增</el-button>
        <el-button icon ="el-icon-edit"  @click="updateDialog()"  type="warning" plain  v-waves   size ="small" round>修改</el-button>
        <el-button  icon ="el-icon-delete" @click="deleteLoophole()"  plain  v-waves type="danger"  size ="small" round>删除</el-button>
          <el-button  icon ="el-icon-delete" plain  v-waves type="danger"  size ="small" round v-if="multipleSelectionFlag" @click="popDelete()">批量删除</el-button>
      </el-col> 
    
      </el-row>
      <addLoopholes :show.sync="show" @addData="addData"></addLoopholes>
      <!-- <updateLoophole :show1.sync="show1" :ruleForm ="LoopholeLibraryId" > </updateLoophole> -->
      <el-row class="search" :gutter="20" >
          <el-col :span ="4">
            <el-input
            placeholder="请输入漏洞名称"
            v-model="t.leakName"  >
          </el-input>
        </el-col>
        <el-col :span ="4" >
              <el-select v-model="t.leakFindMode" placeholder="请漏洞发现方式">
                <el-option   v-for="item in options2"
                  :key="item.value"
                  :label="item.label"
                  :value="item.value"
                  :disabled="item.disabled">                   
                  </el-option>                
              </el-select>
          </el-col> 
          <el-col :span ="4">
            <el-input
            placeholder="请输入漏洞发现者"                  
            v-model="t.leakDiscoverer"      >
            </el-input>     
          </el-col>
            <el-col :span ="4">
          <el-select v-model="t.targetClass" placeholder="请选择漏洞分类">
              <el-option   v-for="item in targetClass"
                :key="item.value"
                :label="item.label"
                :value="item.value"
                :disabled="item.disabled">                   
            </el-option>     
          </el-select> 
        </el-col>  
            <el-col :span ="3">
              <el-button type="primary" plain  icon="el-icon-search" v-waves   @click="searched()" size ="medium"  >查询</el-button>
          </el-col> 
            <el-col :span ="2">
              <el-button  icon="el-icon-refresh"  type="danger" plain  v-waves   @click="reset()" size ="medium"  >重置</el-button>                    
          </el-col>                    
        </el-row>      
    </div>
      <div class="main_list">
      <el-table stripe  border
        ref="multipleTable"
        :data="tableData"
        tooltip-effect="dark"
        style="width: 100%"
        @row-click="checkedselect"
        :row-class-name="tableRowClassName"
        @selection-change="handleSelectionChange"
      >
        <el-table-column type="selection"></el-table-column>
        <el-table-column align="center"  fixed prop="leakName" label="漏洞名称"><template slot-scope="scope">{{scope.row.leakName}}</template></el-table-column>
        <el-table-column align="center" prop="cevNumber" label="漏洞编号" show-overflow-tooltip><template slot-scope="scope">{{scope.row.cevNumber}}</template></el-table-column>
        <!-- <el-table-column align="center"   prop="bugtraqNumber" label="CNCVE编号" show-overflow-tooltip><template slot-scope="scope">{{scope.row.bugtraqNumber}}</template></el-table-column>
        <el-table-column align="center "   prop="cnvLibNumber" label="国家漏洞库编号" show-overflow-tooltip><template slot-scope="scope">{{scope.row.cnvLibNumber }}</template></el-table-column>
        <el-table-column align="center"   prop="cnvdNumber" label="CNVD编号" show-overflow-tooltip><template slot-scope="scope">{{scope.row.cnvdNumber}}</template></el-table-column>
        <el-table-column align="center"  prop="cvssNumber" label="cvss评分" show-overflow-tooltip><template slot-scope="scope">{{scope.row.cvssNumber}}</template></el-table-column> -->
        <el-table-column align="center"   prop="targetClass" label="漏洞分类"> <template slot-scope="scope">{{scope.row.targetClass |targetClass}}</template> </el-table-column>
        <el-table-column align="center"    prop="targetType" label="目标类型"> <template slot-scope="scope">{{scope.row.targetType | getTargetType}}</template> </el-table-column> 
          <el-table-column align="center"  prop="targetSubtype" label="目标子类型"> <template slot-scope="scope">{{scope.row.targetSubtype |getSubType}}</template> </el-table-column>
        <el-table-column align="center"  prop="leakDiscoverer" label="漏洞发现人" show-overflow-tooltip><template slot-scope="scope">{{scope.row.leakDiscoverer }}</template></el-table-column>
          <el-table-column align=center   prop="leakFindMode" label="漏洞发现方式" show-overflow-tooltip><template slot-scope="scope">{{scope.row.leakFindMode=="1"?"人工":"扫描"}}</template></el-table-column>
          <el-table-column align="center"  prop="leakLevel" label="漏洞等级" show-overflow-tooltip><template slot-scope="scope">{{scope.row.leakLevel |leakLevel}}</template></el-table-column>
        <el-table-column align="center" width ="160"   prop="leakDesc" label="漏洞描述"> <template slot-scope="scope">{{scope.row.leakDesc}}</template> </el-table-column>                       
        <!-- <el-table-column align="center" width ="200"   prop="leakEnclosure" label="漏洞附件"> <template slot-scope="scope">{{scope.row.leakEnclosure}}</template> </el-table-column> -->
        <el-table-column align="center" width ="100"   prop="leakEnclosureName" label="附件名称"> <template slot-scope="scope">{{scope.row.leakEnclosureName}}</template> </el-table-column>
        <el-table-column align="center"  prop="repairOpinion" label="修复意见"> <template slot-scope="scope">{{scope.row.repairOpinion}}</template> </el-table-column>                            
        <el-table-column align="center"     prop="LookOver" label="查看">
            <template slot-scope="scope"> 
              <el-tooltip class="item" effect="dark" content="点击查看" placement="top">
                  <i class="el-icon-view" @click="lookover(scope.$index, scope.row)"> </i>
              </el-tooltip> 
            </template>
        </el-table-column>
        <el-table-column align=center  prop="Overscan" label="扫描">
            <template slot-scope="scope"> 
              <el-tooltip class="item" effect="dark" content="点击扫描" placement="top">
                  <i class="el-icon-search" @click="Scan(scope.$index, scope.row)"> </i>
              </el-tooltip> 
            </template>
          </el-table-column>
        </el-table-column>
    </el-table>
    <div class="block">
          <el-pagination  v-show="total>0" background
            @size-change="handleSizeChange"
            @current-change="handleCurrentChange"
            :current-page="currpage"
            :page-sizes="[5,10,20,50]"
            :page-size="pageSize"
            layout="total, sizes, prev, pager, next, jumper"
            :total="total"
          ></el-pagination>
      </div>  
        <!-- 导入弹窗element-ui -->
             <el-dialog
        :title="text"   center
        :visible.sync="importTrue">
        <div style="margin-top: -20px;">
          <el-col :span="24" style="padding: 20px 0;">
            <el-col :span="6" align="center" style="line-height: 36px"> <label for="">批量导入：</label></el-col>
            <el-col :span="12"><el-input v-model="fileName" placeholder="请选择.xls格式的文件"></el-input></el-col>
            <el-col :span="6" align="center">
              <el-upload
                class="upload-demo"
                action='/woc/uploadFile'
                :before-upload="beforeUpload"
                :show-file-list="false"  :file-list="fileList"  ref="uploadfile1"  >
                <el-button type="primary" size ="medium" plain  v-waves> 浏览</el-button>   
              </el-upload>
            </el-col>
          </el-col>
          <el-col :span="24" style="padding: 20px 0;">
            <el-col :span="6" align="center" style="line-height: 36px"> <label for="">选择附件：</label></el-col>
            <el-col :span="12"><el-input v-model="fileName2" placeholder="任意格式附件且内容不能过大"></el-input></el-col>
            <el-col :span="6" align="center">
              <el-upload
                class="upload-demo"
                action='/woc/uploadFile'
                :before-upload="beforeUploads"
                :show-file-list="false"  :file-list="fileList"  ref="uploadfile2"  >
                <el-button type="primary" size ="medium" plain  v-waves>上传附件</el-button>            
              </el-upload>
            </el-col>
          </el-col>
        </div>
        <span slot="footer" class="dialog-footer">
          <el-button type="success" size ="medium" @click="importUserInfo" :disabled="formClick">确 定</el-button>
          <el-button size ="medium" @click="importTrue = false">取 消</el-button>
        </span>
      </el-dialog>
        <!-- 修改弹窗 -->
            <el-dialog :title="title1" width ="900px"  :visible.sync="dialogformVisible" center=""  @close="$emit('update:show1', false)" :show="show1" >
                      <el-form :model="ruleForm"  ref="ruleForm"  >
                          <el-row >
                            <el-col :span="12">
                                <el-form-item label="漏洞编号" :label-width="formLabelWidth" prop ="cevNumber">
                                  <el-input v-model="ruleForm.cevNumber" autocomplete="off" ></el-input>
                                </el-form-item>
                               <el-form-item label="目标类型" :label-width="formLabelWidth"   prop ="targetType">
                                  <el-select v-model="ruleForm.targetType==1?'主机':ruleForm.targetType==2?'中间件':ruleForm.targetType==3?'数据库':'应用系统'" placeholder="请选择目标类型" :disabled ="disable" class ="size-full">
                                  </el-select>
                                </el-form-item>
                                <el-form-item label="漏洞位置" :label-width="formLabelWidth" prop ="leakTargetLocaltion" >
                                  <el-input v-model="ruleForm.leakTargetLocaltion" autocomplete="off"  ></el-input>
                                </el-form-item>
                              
                                <el-form-item label="目标分类" :label-width="formLabelWidth" prop="targetClass" >
                                <el-select v-model="ruleForm.targetClass" placeholder="请选择漏洞分类" class="size-full">            
                                    <el-option   v-for="item in targetClass"
                                      :key="item.value"
                                      :label="item.label"
                                      :value="item.value"
                                      :disabled="item.disabled">                   
                                      </el-option>                
                                  </el-select>
                                </el-form-item> 
                                        <el-form-item label="漏洞发现人" :label-width="formLabelWidth" prop ="leakDiscoverer">
                                          <el-input v-model="ruleForm.leakDiscoverer" autocomplete="off"></el-input>
                                        </el-form-item>
                                      </el-col>
                                      <el-col :span="12">
                                        <el-form-item label="漏洞名称" :label-width="formLabelWidth" prop ="leakName">
                                            <el-input v-model="ruleForm.leakName" autocomplete="off"></el-input>
                                          </el-form-item>
                                        <el-form-item label="子级类型" :label-width="formLabelWidth"   prop ="targetSubtype">
                                            <el-select v-model="ruleForm.targetSubtype==5?'mysql':ruleForm.targetSubtype=='6'?'redis':ruleForm.targetSubtype==7?'rabbitMQ':ruleForm.targetSubtype==8?'activeMQ':ruleForm.targetSubtype==9?'centos':ruleForm.targetSubtype==9?'centos':'xx管理系统'" placeholder="请选择子级类型" :disabled ="disable" class="size-full">
                                              <el-option v-for="item in assetSubtypeClassArr"
                                                  :key="item.id"
                                                  :value="item.id"
                                                  :label="item.assetsTypeName" >
                                                </el-option>
                                            </el-select>
                                          </el-form-item>
                                      <el-form-item label="漏洞等级" :label-width="formLabelWidth" prop="leakLevel" >
                                      <el-select v-model="ruleForm.leakLevel" placeholder="请选择漏洞等级" class="size-full">            
                                          <el-option   v-for="item in leakLevels"
                                            :key="item.value"
                                            :label="item.label"
                                            :value="item.value"
                                            >                   
                                            </el-option>                
                                        </el-select>
                                       </el-form-item>  
                                         <el-form-item label="附件名称"  :label-width="formLabelWidth" prop ="leakEnclosureName" >
                                            <el-input v-model="ruleForm.leakEnclosureName"  placeholder="请选择漏洞附件" autocomplete="off"></el-input>
                                        </el-form-item>
                                        <el-form-item label="添加附件"  :label-width="formLabelWidth" prop="leakEnclosure">
                                            <!-- <el-input  size="small"
                                              v-model="ruleForm.leakEnclosure"
                                              readonly="readonly"
                                              placeholder="附件"
                                              style="width:240px;"
                                            ></el-input> -->
                                            <el-button type="primary" size="small" @click="upload">点击上传</el-button>
                                            <input
                                              style="display:none"
                                              type="file"
                                              ref="file"
                                              name="files"
                                              id="file"
                                              @change="uploadFile()"
                                            />
                                        </el-form-item>
                                      </el-col>
                                    </el-row>
                                    <el-row>
                                      <el-col :span="24">
                                        <el-form-item label="漏洞描述:" :label-width="formLabelWidth" prop ="leakDesc" >
                                          <el-input
                                                type="textarea"
                                                placeholder="请输入漏洞描述内容"
                                                v-model="ruleForm.leakDesc"
                                                maxlength="30" 
                                                show-word-limit
                                              >
                                          </el-input>
                                        </el-form-item>
                                      </el-col>
                                      <el-col>
                                        <el-form-item label="漏洞修复意见" :label-width="formLabelWidth" prop ="repairOpinion">
                                          <el-input v-model="ruleForm.repairOpinion" autocomplete="off"></el-input>
                                        </el-form-item>
                                      </el-col>
                                    </el-row>
                                  </el-form>
                          <div slot="footer" class="dialog-footer">
                            <el-button type="danger" size="small" icon="el-icon-refresh" @click="dialogformVisible = false">取 消</el-button>
                            <el-button  size="small" icon ="el-icon-edit" type="primary" @click="updateVulnerability()">修改</el-button>
                          </div>
              </el-dialog>
        <!-- 查看弹框 -->
        <el-dialog :title="title2" width="900px" :visible.sync="dialogFormVisible" center  @close="$emit('update:show', false)" :show="show" >
              <el-form :model="ruleForm"  ref="ruleForm"  >
                <el-row >
                  <el-col :span="12">
                      <el-form-item label="漏洞编号" :label-width="formLabelWidth" prop ="cevNumber">
                        <el-input v-model="ruleForm.cevNumber" autocomplete="off" :disabled ="disable" ></el-input>
                      </el-form-item>
                      <el-form-item label="漏洞位置" :label-width="formLabelWidth" prop ="leakTargetLocaltion" >
                        <el-input v-model="ruleForm.leakTargetLocaltion" autocomplete="off" :disabled ="disable"  ></el-input>
                     </el-form-item>
                  
                      <el-form-item label="目标类型" :label-width="formLabelWidth"   prop ="targetType">
                        <el-select v-model="ruleForm.targetType" placeholder="请选择目标类型" :disabled ="disable" class ="size-full">
                        </el-select>
                      </el-form-item>
                      
                      <el-form-item label="目标分类" :label-width="formLabelWidth" prop="targetClass" >
                      <el-select v-model="ruleForm.targetClass" placeholder="请选择漏洞分类" :disabled ="disable" class="size-full">            
                          <el-option   v-for="item in targetClass"
                            :key="item.value"
                            :label="item.label"
                            :value="item.value"
                            :disabled="item.disabled">                   
                            </el-option>                
                        </el-select>
             </el-form-item> 
                    <el-form-item label="漏洞发现人" :label-width="formLabelWidth" prop ="leakDiscoverer">
                      <el-input v-model="ruleForm.leakDiscoverer" :disabled ="disable" autocomplete="off"></el-input>
                    </el-form-item>
                  </el-col>
                  <el-col :span="12">
                    <el-form-item label="漏洞名称" :label-width="formLabelWidth" prop ="leakName">
                        <el-input v-model="ruleForm.leakName" autocomplete="off" :disabled ="disable"></el-input>
                    </el-form-item>                                     
                     <el-form-item label="漏洞等级" :label-width="formLabelWidth" prop="leakLevel" >
                        <el-select v-model="ruleForm.leakLevel" placeholder="请选择漏洞等级" :disabled ="disable" class="size-full">                  
                        </el-select>
                    </el-form-item> 
                    <el-form-item label="子级类型" :label-width="formLabelWidth"   prop ="targetSubtype">
                        <el-select v-model="ruleForm.targetSubtype==5?'mysql':ruleForm.targetSubtype=='6'?'redis':ruleForm.targetSubtype==7?'rabbitMQ':ruleForm.targetSubtype==8?'activeMQ':ruleForm.targetSubtype==9?'centos':'xx管理系统'" placeholder="请选择子级类型" :disabled ="disable" class ="size-full">
                        </el-select>
                      </el-form-item>
                       <el-form-item label="附件名称"  :label-width="formLabelWidth" prop ="leakEnclosureName" >
                           <el-input v-model="ruleForm.leakEnclosureName" :disabled ="disable"  placeholder="请选择漏洞附件" autocomplete="off"></el-input>
                    </el-form-item>
                    <el-form-item label="添加附件"  :label-width="formLabelWidth" prop="leakEnclosure">
                        <!-- <el-input  size="small"
                          v-model="ruleForm.leakEnclosure"
                          readonly="readonly"
                          placeholder="附件"
                          style="width:240px;" :disabled ="disable"
                        ></el-input> -->
                        <el-button type="primary"  :disabled ="disable" size="small" @click="upload">点击上传</el-button>
                        <input
                          style="display:none"
                          type="file"
                          ref="file"
                          name="files"
                          id="file"
                          @change="uploadFile()"
                        />
                    </el-form-item>          
                  </el-col>
                </el-row>
                <el-row>
                  <el-col :span="24">
                    <el-form-item label="漏洞描述:" :label-width="formLabelWidth" prop ="leakDesc" >
                      <el-input
                            type="textarea"
                            placeholder="请输入漏洞描述内容"
                            v-model="ruleForm.leakDesc"
                            maxlength="30" :disabled ="disable" 
                            show-word-limit
                          >
                      </el-input>
                    </el-form-item>
                  </el-col>
                  <el-col :span="24">
                    <el-form-item label="漏洞修复意见" :label-width="formLabelWidth" prop ="repairOpinion">
                      <el-input v-model="ruleForm.repairOpinion" autocomplete="off" :disabled ="disable"></el-input>
                    </el-form-item>
                  </el-col>
                </el-row>
              </el-form>
             <div slot="footer" class="dialog-footer">
                  <el-button type="danger" @click="dialogFormVisible = false">关闭</el-button>         
            </div>
            </el-dialog>
    </div>
  </div>
</template>

<script>
  import addLoopholes from './addLoophole'
  // import updateLoophole from './updateLoophole'
  import waves from '@/directive/waves/index.js' // 水波纹指令
  import { addLoophole,assetLibraryPageCondition,deleteLoophole,delleteloopholeLibrary,getseeAssetLibrary,scanning,updateLoophole,uploadFile,importLoophole} from "@/api/Vulnerability"
  import {getAssetSubType,getAssetParentType,getAssetAllTypes} from "@/api/assetsType"
  export default {
    name:'',
    props:[''],
    data () {
      return {
          fileData1:{},
          fileData2:{},
          uploadForm: new FormData(),
          fileName:'',
          fileName2:'',
          fileType:'',
          text:"批量导入漏洞",
          formClick:false,
          importTrue:false,
          title1:"修改漏洞",
          title2:"漏洞详情",
          file: {},
          leakEnclosurefile:{},
          fileList:[],
          leakEnclosurefileList:[],  
          content:"",
          show:false,
          show1:false,
          show2:false,
          disable:true,
          dialogFormVisible:false,
          dialogformVisible:false,
          dialogImport:false,
          assetTypeClassArr:[],
          assetSubtypeClassArr:[],
          loopholeId:"",
          loopholeIds:"",
          formLabelWidth: '100px',
          targetClass:[
              {
              value: '0',
              label: '第三方组件'
            }, {
              value: '1',
              label: '自研应用'
            }
          ],
           ruleForm: {
            id:"",
            cevNumber:"",
            repairOpinion:"",
            leakDiscoverer:"",
            leakName:"",
            leakLevel:"",
            targetType:"",
            targetSubtype:"",
            leakEnclosureName:"",
            leakEnclosure:"",
            targetClass:"",
            leakTargetLocaltion:"",
            leakDesc:"",
        },
        leakLevels:[{
              value: '1',
              label: '低'
              },
            {
              value: '2',
              label: '中'
            },
              {
              value: '3',
              label: '高'
            },
        ],
        multipleSelectionFlag:false,
           options2:[
            {
              value: '1',
              label: '人工'
            }, {
              value: '0',
              label: '扫描'
            },
          ],
         t: {
            id:null,
            targetClass: null,
            leakName: null,
            leakLevel:null,
            leakDiscoverer: null,
            targetSubtype: null,
            targetType: null,
            leakFindMode:null
          },
          value:"",
          pageSize: 10,  //每页显示条数
          currpage:1,    //当前页
          total:0,
          total2:0,
          totalPage:1,
          // LoopholeLibraryId:{},
          LoopholeLibraryId:1,

          dataSlection:[],
          multipleSelection:[],
          tableData:[

          ]

      };
    },
    directives:{
      waves
    },
    filters:{
     getSubType:function(status){ 
      const AssetSubType = {
            5:'mysql',
            6:'redis',
            7:'rabbitMQ',
            8:'activeMQ',
            9:"centos",
            10:"xx管理系统"
      }
       return AssetSubType[status]
     },
      getTargetType:function(status){
         const targetType = {
            1:'主机',
            2:'中间件',
            3:'数据库',
            4:'应用系统' 
      }
       return targetType[status]
     },
     targetClass(status){
         const targetClass = {
            0:"第三方组件",
            1:"自研应用"
        }
        return targetClass[status]
     },
     leakLevel(status){
        const leakLevel = {
            1:"低",
            2:"中",
            3:"高"
        }
        return leakLevel[status]
     }
    
    },
    components: {
     addLoopholes
    },

    computed: {},

    mounted() {
        this.getTableData()
     },

    methods: {
      handleAdd () {
        this.show = true;
      },
     
      getTableData(){
        assetLibraryPageCondition({pageNum: this.currpage,pageSize: this.pageSize,t:{}}).then(res =>{
           this.tableData =res.data.datas;
           this.total = res.data.totalNum
        })
      },
         //获取子级列表
      assetTypeClass(params){
        this.t.targetSubtype = "";
        getAssetSubType({superclassId:params}).then(res =>{   
          this.assetSubtypeClassArr = res.data.data;  
          con
        })
        
      },
        //批量删除
     popDelete(){
           this.$confirm('此操作将永久删除这些漏洞, 是否继续?', '提示', {
              confirmButtonText: '确定',
              cancelButtonText: '取消',
              type: 'warning'       
           }).then(()=>{
               this.dataSlection = this.dataSlection.join(",")
              this.loopholeIds = this.dataSlection 
                delleteloopholeLibrary({loopholeIds:this.loopholeIds}).then(res =>{
                  if(res.data.code==0){
                        this.getTableData()
                        this.$message.success(res.data.msg)
                  }else{
                      this.$message.error(res.data.msg)
                  }
                })
           })
        
      },
      changeleakEnclosurefiles(){

      },
      //搜索
         searched(){
          this.searchDisable =false
          if (this.t.targetClass||this.t.leakName||this.t.id||this.t.targetSubtype||this.t.leakLevel||this.t.leakFindMode||this.t.leakDiscoverer) {
            assetLibraryPageCondition({pageNum: this.currpage,pageSize: this.pageSize*1,t:{
                targetClass:this.t.targetClass,
                leakName:this.t.leakName,
                targetType:this.t.id,
                targetSubtype:this.t.targetSubtype,
                leakLevel:this.t.leakLevel,
                leakFindMode:this.t.leakFindMode,
                leakDiscoverer:this.t.leakDiscoverer
            }}).then(res => {
                this.tableData =res.data.datas 
                this.total = res.data.totalNum
                this.totalPage =res.data.totalPage   
        })
          }else{
            //  this.$confirm('至少选则一个搜索项！', '提示', {
            //       confirmButtonText: '确定',
            //       cancelButtonText: '取消',
            //        type: 'warning'
            //  })
              this.getTableData()
          }
      },
       //重置
      reset(){
         
          this.t.id =null;
          this.t.targetClass =null;
          this.t.leakName =null;
          this.t.targetSubtype =null;
          this.t.leakLevel =null;
          this.t.leakFindMode =null;
          this.t.leakDiscoverer =null
          this.$message({
                  type: 'success',
                  message: '所有搜索项已为空'
           }); 

    },
      //扫描漏洞
       Scan(index,row){
          this.loopholeId = row.id;
          scanning({loopholeId:this.loopholeId}).then(res =>{
            if(res.data.code ==1){
             this.$confirm(res.data.msg, '提示', {
                confirmButtonText: '确定',
                cancelButtonText: '取消',
                type: 'warning'
              })
            }else if(res.data.code =="0"){
             this.$confirm(res.data.msg, '告警提示', {
                confirmButtonText: '跳转',
                cancelButtonText: '取消',
                type: 'warning',            
              }).then(()=>{
                this.$router.push({path:"/workOrder/Orderdetails/index"})
              })
            }else{
               this.$confirm('扫描异常！请核查该资产数据是否正常或联系管理员', '告警提示', {
                confirmButtonText: '确定',        
                type: 'warning',
                       
              })
            }
          })
      },
      addData(){
          this.getTableData()
      },
      //回显修改
      updateDialog () {
        if(this.multipleSelection.length <= 0) {
          this.$message.warning("请选择要修改的数据");
          return;
        } else if(this.multipleSelection.length > 1) {
          this.$message.warning("只能选择一条数据进行修改");
        } else {
            this.dialogformVisible = true;
            this.LoopholeLibraryId =this.dataSlection[0]
             getseeAssetLibrary({
                  loopholeLibraryId:this.LoopholeLibraryId}).then(res=>{
                  this.ruleForm.targetClass = res.data.data.targetClass;
                  this.ruleForm.targetType = res.data.data.targetType;
                  this.ruleForm.targetSubtype = res.data.data.targetSubtype;
                  this.ruleForm.cevNumber = res.data.data.cevNumber;
                  this.ruleForm.leakName = res.data.data.leakName;
                  this.ruleForm.leakDesc = res.data.data.leakDesc;
                  this.ruleForm.leakEnclosure = res.data.data.leakEnclosure;
                  this.ruleForm.leakEnclosureName = res.data.data.leakEnclosureName;
                  this.ruleForm.leakTargetLocaltion = res.data.data.leakTargetLocaltion;
                  this.ruleForm.repairOpinion =   res.data.data.repairOpinion;
                  this.ruleForm.leakLevel =   res.data.data.leakLevel;
                  this.ruleForm.leakDiscoverer =   res.data.data.leakDiscoverer;  
                              
                  // if (res.data.data.leakLevel == 1) {
                  //     this.ruleForm.leakLevel = '低'
                  //   } else if (res.data.data.leakLevel == 2) {
                  //     this.ruleForm.leakLevel = '中'
                  //   } else if (res.data.data.leakLevel == 3) {
                  //     this.ruleForm.leakLevel = '高'
                  //   } else {
                  //     return
                  //   }
                
                    // if (res.data.data.targetType== 1) {
                    // this.ruleForm.targetType = '主机'
                    // } else if (res.data.data.targetType== 2) {
                    // this.ruleForm.targetType = '中间件'
                    // } else if (res.data.data.targetType == 3) {
                    // this.ruleForm.targetType = '数据库'
                    // }  else if (res.data.data.targetType==4){
                    //    this.ruleForm.targetType = '应用系统'
                    // }                  
          })
           
        }   
      },
      //确定修改漏洞
        updateVulnerability(){
             this.dialogformVisible = false;
              this.LoopholeLibraryId =this.dataSlection[0]
              updateLoophole({
                targetClass:this.ruleForm.targetClass,
                targetType:this.ruleForm.targetType,
                targetSubtype:this.ruleForm.targetSubtype,
                cevNumber:this.ruleForm.cevNumber,
                leakName:this.ruleForm.leakName,
                leakDesc:this.ruleForm.leakDesc,
                leakEnclosure:this.ruleForm.leakEnclosure,
                leakTargetLocaltion:this.ruleForm.leakTargetLocaltion,
                repairOpinion:this.ruleForm.repairOpinion,
                leakLevel:this.ruleForm.leakLevel,
                leakDiscoverer:this.ruleForm.leakDiscoverer,
                id: this.LoopholeLibraryId
              }).then(res =>{
                if(res.data.code == 0){
                   if(res.data.code=="0"){
                    this.$message.success(res.data.msg)
                    this.getTableData()
                  }else{
                      this.$message.error(res.data.msg)
                  }
                  this.getTableData()
                }
              })
        },  
       lookover(index,row){
          this.dialogFormVisible = true;
          this.LoopholeLibraryId =row.id
          getseeAssetLibrary({
            loopholeLibraryId:this.LoopholeLibraryId}).then(res=>{
              this.ruleForm.targetClass = res.data.data.targetClass;
              this.ruleForm.targetType = res.data.data.targetType;
              this.ruleForm.targetSubtype = res.data.data.targetSubtype;
              this.ruleForm.cevNumber = res.data.data.cevNumber;
              this.ruleForm.leakName = res.data.data.leakName;
           
              this.ruleForm.leakEnclosure = res.data.data.leakEnclosure;
              this.ruleForm.leakEnclosureName = res.data.data.leakEnclosureName;
              this.ruleForm.leakTargetLocaltion = res.data.data.leakTargetLocaltion;
              this.ruleForm.repairOpinion =   res.data.data.repairOpinion;
              this.ruleForm.leakLevel =   res.data.data.leakLevel;
              this.ruleForm.leakDiscoverer =   res.data.data.leakDiscoverer;                
              if (res.data.data.leakLevel == 1) {
                   this.ruleForm.leakLevel = '低'
                } else if (res.data.data.leakLevel == 2) {
                  this.ruleForm.leakLevel = '中'
                } else if (res.data.data.leakLevel == 3) {
                  this.ruleForm.leakLevel = '高'
                } else {
                  return
                }
                if (res.data.data.targetType== 1) {
                 this.ruleForm.targetType = '主机'
                } else if (res.data.data.targetType== 2) {
                 this.ruleForm.targetType = '中间件'
                } else if (res.data.data.targetType == 3) {
                 this.ruleForm.targetType = '数据库'
                } else if (res.data.data.targetType == 4) {
                   this.ruleForm.targetType = '应用系统'
                }
             
               
                
          })
         
      },   
      deleteLoophole(){
          // deleteLoophole({id:this.LoopholeLibraryId.id})
        if(this.multipleSelection.length <= 0) {
          this.$message.info("请选择要删除的数据");
          return;
        } else if(this.multipleSelection.length > 1) {
          this.$message.warning("只能选择一条数据进行删除");
        }else{
           this.$confirm('此操作将永久删除该漏洞, 是否继续?', '提示', {
              confirmButtonText: '确定',
              cancelButtonText: '取消',
              type: 'warning'
           }).then(() => {       
               this.LoopholeLibraryId =this.dataSlection[0]
              //  console.log("this.dataSlection",this.dataSlection[0])
                deleteLoophole({id:this.LoopholeLibraryId}).then(res =>{
                  if(res.data.code ==0){
                    this.getTableData()                 
                     this.$message({
                        type: 'success',
                        message: '删除成功!'
                      });                  
                  }else{
                       this.$message({
                        type: 'error',
                        message: res.data.msg
                      });    
                  }
                })  
             
          }).catch(() => {
              this.$message({
                type: 'info',
                message: '已取消删除'
              });          
            })    
        }      
      },
    // 下载导入模板
      downloadFile () {
        var self = this;
        window.location.href = "/llc/exportTemplate";
      },
       // 导入按钮
      importButton () {
        this.importTrue = true   
      },
      beforeUpload:function (file1) {
          this.fileName = file1.name;
          this.fileData1=file1;
          return false
      },
      beforeUploads:function (file2) {
          this.fileName2 = file2.name;
          this.fileData2 = file2   
          return false
      },
    
    
     // 将文件信息传给后台
    importUserInfo() {
      let transData = new FormData()
      if(this.fileName!==""&&this.fileName2 !==""){
         transData.append("file", this.fileData1)
         transData.append("leakEnclosurefile", this.fileData2)
         this.importInfoNormal(transData)
      }else if(this.fileName ==""&&this.fileName2 !==""){
           this.$message.error('请导入模板内容(.xls格式)')
      }else if(this.fileName2 ==""&&this.fileName !==""){
          this.$message.error('请上传附件')
      }else{
          this.$message.error('请导入模板内容和上传附件')
      }
   
    },
     
      //////////////////, 
      
       // 将数据传给后台
    importInfoNormal(transData) {
      //后台接口
      importLoophole(transData).then(res =>{
        if(res.data.code ==0){
          // this.getTableData()
          // this.$alert(res.data.msg,'提示', {
          //   confirmButtonText: '确定',
          //   type: 'success'       
          //  }).then( ()=>{
          //     this.importTrue =false;
          //     this.getTableData()
          //     this.fileName ="";
          //     this.fileName2 ="";
          //   // this.$refs.uploadfile.clearFiles()
          //  })
          this.$message.success(res.data.msg) 
          this.getTableData()
          this.fileName ="";
          this.fileName2 ="";
                          
        }else if(res.data.code ==1){
           this.$confirm("上传失败，批量导入数据时必须(.xls格式)",'提示', {
              confirmButtonText: '确定',
              cancelButtonText: '取消',
              type: 'error'       
           }) 
        }else{
          this.$message.error("导入模板存在问题")
        }
      })
  },
     
      upload() {
            this.$refs.file.click();
      },

      uploadFile() {
      // debugger
        let files = this.$refs.file.files;
        if (files.length > 1) {
          $this.$alert("只能上传1个文件！", "提示", {
            confirmButtonText: "确定"
          });
        } else {
          this.checkFileInfo(files);
        }
    },
     checkFileInfo(files) {
      let formData = new FormData();
      formData.append("file",files[0]);
      let maxSize = 20 * 1024 * 1024;
      let name = files[0].name;
 
      // let fileName = name.substring(name.lastIndexOf(".") + 1).toLowerCase();
      // console.log(fileName)
      this.ruleForm.leakEnclosureName =name
      {
        if (files[0].size > maxSize) {
          this.$confirm("上传文件大小应小于20M！", "提示", {
            confirmButtonText: '确定',
            type: 'error'       
          });
          return;
        } else {
           uploadFile(formData).then(res =>{
              if(res.data.code==0){
                this.ruleForm.leakEnclosure = res.data.data;
              }
            })
        }
      }
    },
    checkedselect(row) {
      this.$refs.multipleTable.toggleRowSelection(row);
    },

    handleSizeChange(val) {
        this.pageSize = val;
        this.getTableData()
        // this.searched()
    },
    handleCurrentChange(val) {     
      this.currpage = val;
       this.getTableData()
      //  this.searched()
    },

    handleSelectionChange(val) {
       this.multipleSelection = val;
      if (this.multipleSelection.length > 1) {   
        // 如不进行判断则勾选完毕后批量删除按钮还是会在
        this.multipleSelectionFlag = true;
      }else{
            this.multipleSelectionFlag = false;
      }  
        this.dataSlection = [];
        this.multipleSelection = [];
        val.forEach( item =>{
          this.dataSlection.push(item.id)
            // console.log(this.dataSlection)
          this.multipleSelection.push(item)
        })
       
    },
     //行选中样式
    tableRowClassName({ row, rowIndex }) {
      for (var i = 0; i < this.multipleSelection.length; i++) {
        if (this.multipleSelection[i] == row) {
          return "warning-row";
        }
      }
      return "";
    },
        //行选中
    
    },

    watch: {}

  }

</script>
<style lang='scss' scoped>
  .topButton{
    margin-top: 50px;
  }

 .block{
    margin: 20px;
    text-align: center;
  }
  .size-full{
    width:100%
  }
   .textWidth{
    width: 91%;
  }
  .search{
    margin:15px ;
  }
</style>